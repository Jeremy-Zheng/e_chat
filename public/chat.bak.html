<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>Epoching聊天室---Easy chat</title>

        <link rel="stylesheet" href="stylesheets/libs/bootstrap.min.css"/>
        <link rel="stylesheet" href="stylesheets/my_css/chat.bak.css"/>

        <script src="javascripts/libs/jquery-2.1.1.min.js"></script>
        <script src="javascripts/libs/bootstrap.min.js"></script>

        <script src="/socket.io/socket.io.js"></script>
    </head>

    <body>

        <div class="modal fade" id="myModal"
             data-keyboard="false"
             data-backdrop="static"
             tabindex="-1"
             role="dialog"
             aria-labelledby="myModalLabel">
            aria-hidden="true">

            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="myModalLabel">
                            请填写您的姓名:
                        </h4>
                    </div>
                    <div class="modal-body">

                        <input id="name" type="text" class="form-control">

                        <span id="notice" class="label label-danger">对不起，请正确填写姓名……</span>

                    </div>
                    <div class="modal-footer">

                        <button id="submit_name" type="button" class="btn btn-primary">
                            确定
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <h1>Easy talk</h1>

        <div class="input-group">


            <div class="input-group-btn">
                <button id="start_chat" class="btn btn-success">开始聊天</button>
                <button id="change" class="btn btn-primary">切换</button>
            </div>
        </div>

        <textarea id="textarea" disabled="disabled"></textarea>

        <div class="input-group">
            <input id="text" type="text" class="form-control">

            <div class="input-group-btn">
                <button id="submit_msg" class="btn btn-success">send</button>
            </div>
        </div>

    </body>
</html>


<script>

    $(document).ready(function () {

        var socket = io();
        var $_textarea = $("#textarea");        //显示文本框区域
        var $_submit_name = $("#submit_name");  //提交名字信息的按钮
        var $_submit_msg = $("#submit_msg");    //提交发送聊天信息的按钮
        var $_input = $("#text");               //输入框
        var $_start_btn = $("#start_chat");       //开始聊天按钮
        var $_change_btn = $("#change");          //切换聊天按钮

        var is_pair = false;


        //刚开始 就显示模态框 要用户输入自己的名字
        //并且让输入框获取到焦点
        var $_modal = $("#myModal");            //模态框
        var $_name = $("#name");                //模态框里面输入名字的输入框
        $_modal.modal('show');
        $_modal.on('shown.bs.modal', function () {
            $_name.focus();
        });

        //点击提交姓名按钮
        $_submit_name.on("click", function () {
            send_name();

        });

        //按回车键发送名字消息
        $_name.keypress(function (event) {
            if (event.which == 13)
                send_name();
        });

        //发送一个信号给后台，表示可以为我配对聊天了
        $_start_btn.on("click", function (event) {

            //如果等于1，表示已经连过了。。。。。。
            //否则表示这是第一次连，或者上次没有连上
            if (!$_start_btn.once ==1) {
                $_start_btn.once = 1;
                socket.emit("is_ready", true);

                socket.on("is_ready", function (data) {
                    if (data == true) {
                       // $_start_btn.hide();
                    }
                    else
                        $_start_btn.once = 0;
                })
            }
            else{
                $_textarea.append("正在为您配对中……请耐心等待……" + "\n");
            }

        });

        //点击发送消息
        $_submit_msg.on("click", function () {
            send_msg()
        });

        //按回车键发送消息
        $_input.keypress(function (event) {
            if (event.which == 13)
                send_msg()
        });

        //点击切换聊天
        $_change_btn.on("click", function () {

            if (is_pair) {
                socket.emit("change", "true");
            }
            else {
                $_textarea.append("对不起你还没有配对……" + "\n");
            }


        });

        //接受后台给的信号表示现在处于配对状态
        socket.on("is_pair", function (data) {
            is_pair = data;
        });

        //接受聊天消息,显示到消息面板上
        socket.on('msg', function (data) {
            $_textarea.append(data + "\n");
        });

        //接受聊天消息,显示到消息面板上
        socket.on('disconnect', function (data) {
            $_textarea.append("fuck，服务器挂掉了……" + "\n");
        });

        //发送姓名消息的函数
        function send_name() {
            //判断字符串长度,不符合要求就进行提示
            if ($_name.val() == "" || $_name.val() == null) {
                $("#notice").slideDown();
                $("#notice").on("click", function () {
                    $(this).slideUp();
                    $(this).unbind("click");
                });

                return false;
            }

            //提交到后台
            socket.emit('name', $_name.val());


            //隐藏模态框,聊天输入框获取焦点
            $_modal.modal('hide');
            $_input.focus();
        }

        //发送聊天消息的函数
        function send_msg() {
            if (is_pair) {
                //发送消息
                socket.emit('msg', $_input.val());
            }
            else {
                $_textarea.append("对不起你还没有配对……" + "\n");
            }

            //输入框清空，获取焦点
            $_input.val("");
            $_input.focus();
        }

    })
</script>